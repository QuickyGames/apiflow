<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CRUD Operations</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        form { max-width: 600px; margin-bottom: 20px; }
        label { display: block; margin-top: 10px; }
        input[type="text"], textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
    </style>
</head>
<body>

<h1>CRUD Operations</h1>

<!-- Display Users -->
<h2>Users</h2>
<table id="users-table" border="1">
    <thead>
        <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Display Nodes -->
<h2>Nodes</h2>
<table id="nodes-table" border="1">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Content</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Display Workflows -->
<h2>Workflows</h2>
<table id="workflows-table" border="1">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Content</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- User CRUD -->
<h2>User Operations</h2>
<form id="create-user-form">
    <label for="user-email">Email:</label>
    <input type="text" id="user-email" name="email" required>
    <button type="submit">Create User</button>
</form>

<!-- Node CRUD -->
<h2>Node Operations</h2>
<form id="create-node-form">
    <label for="node-owner">Owner:</label>
    <select id="node-owner" name="owner_id" required></select>
    <label for="node-name">Name:</label>
    <input type="text" id="node-name" name="name" required>
    <label for="node-content">Content:</label>
    <textarea id="node-content" name="content" rows="4" required></textarea>
    <button type="submit">Create Node</button>
</form>

<!-- Workflow CRUD -->
<h2>Workflow Operations</h2>
<form id="create-workflow-form">
    <label for="workflow-owner">Owner:</label>
    <select id="workflow-owner" name="owner_id" required></select>
    <label for="workflow-name">Name:</label>
    <input type="text" id="workflow-name" name="name" required>
    <label for="workflow-content">Content:</label>
    <textarea id="workflow-content" name="content" rows="4" required></textarea>
    <button type="submit">Create Workflow</button>
</form>

<script>
function createUserRow(user) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${user.id}</td>
        <td contenteditable="true" data-field="email">${user.email}</td>
        <td>
            <button onclick="saveUser(${user.id})">Save</button>
            <button onclick="deleteUser(${user.id})">Delete</button>
        </td>
    `;
    return row;
}

function createNodeRow(node) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${node.id}</td>
        <td contenteditable="true" data-field="name">${node.name}</td>
        <td contenteditable="true" data-field="content">${node.content}</td>
        <td>
            <button onclick="saveNode(${node.id})">Save</button>
            <button onclick="deleteNode(${node.id})">Delete</button>
        </td>
    `;
    return row;
}

function createWorkflowRow(workflow) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${workflow.id}</td>
        <td contenteditable="true" data-field="name">${workflow.name}</td>
        <td contenteditable="true" data-field="content">${workflow.content}</td>
        <td>
            <button onclick="saveWorkflow(${workflow.id})">Save</button>
            <button onclick="deleteWorkflow(${workflow.id})">Delete</button>
        </td>
    `;
    return row;
}

function displayUsers(users) {
    const tableBody = document.querySelector('#users-table tbody');
    tableBody.innerHTML = '';
    users.forEach(user => tableBody.appendChild(createUserRow(user)));
}

function displayNodes(nodes) {
    const tableBody = document.querySelector('#nodes-table tbody');
    tableBody.innerHTML = '';
    nodes.forEach(node => tableBody.appendChild(createNodeRow(node)));
}

function displayWorkflows(workflows) {
    const tableBody = document.querySelector('#workflows-table tbody');
    tableBody.innerHTML = '';
    workflows.forEach(workflow => tableBody.appendChild(createWorkflowRow(workflow)));
}

function populateOwnerSelect(selectElement, users) {
    selectElement.innerHTML = '<option value="">Select a user</option>';
    users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `User ${user.id} (${user.email})`;
        selectElement.appendChild(option);
    });
}

function fetchAndDisplayAll() {
    // Fetch and display users
    fetch('/users/')
        .then(response => response.json())
        .then(data => {
            displayUsers(data);

            // Populate owner selects for forms
            const nodeOwnerSelect = document.getElementById('node-owner');
            const workflowOwnerSelect = document.getElementById('workflow-owner');
            populateOwnerSelect(nodeOwnerSelect, data);
            populateOwnerSelect(workflowOwnerSelect, data);
        })
        .catch(error => console.error('Error fetching users:', error));

    // Fetch and display nodes
    fetch('/nodes/')
        .then(response => response.json())
        .then(data => displayNodes(data))
        .catch(error => console.error('Error fetching nodes:', error));

    // Fetch and display workflows
    fetch('/workflows/')
        .then(response => response.json())
        .then(data => displayWorkflows(data))
        .catch(error => console.error('Error fetching workflows:', error));
}

// Initial load
fetchAndDisplayAll();

function saveUser(id) {
    const row = document.querySelector(`#users-table tr[data-id="${id}"]`);
    const email = row.querySelector('[data-field="email"]').innerText;

    fetch(`/users/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => alert(`User ${id} updated`))
    .catch(error => console.error('Error:', error));
}

function deleteUser(id) {
    if (confirm(`Are you sure you want to delete user with ID ${id}?`)) {
        fetch(`/users/${id}`, {
            method: 'DELETE'
        })
        .then(() => {
            alert(`User ${id} deleted`);
            // Refresh the list
            fetch('/users/')
                .then(response => response.json())
                .then(data => displayUsers(data))
                .catch(error => console.error('Error refreshing users:', error));
        })
        .catch(error => console.error('Error:', error));
    }
}

function saveNode(id) {
    const row = document.querySelector(`#nodes-table tr[data-id="${id}"]`);
    const name = row.querySelector('[data-field="name"]').innerText;
    const content = row.querySelector('[data-field="content"]').innerText;

    fetch(`/nodes/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, content: content })
    })
    .then(response => response.json())
    .then(data => alert(`Node ${id} updated`))
    .catch(error => console.error('Error:', error));
}

function deleteNode(id) {
    if (confirm(`Are you sure you want to delete node with ID ${id}?`)) {
        fetch(`/nodes/${id}`, {
            method: 'DELETE'
        })
        .then(() => {
            alert(`Node ${id} deleted`);
            // Refresh the list
            fetch('/nodes/')
                .then(response => response.json())
                .then(data => displayNodes(data))
                .catch(error => console.error('Error refreshing nodes:', error));
        })
        .catch(error => console.error('Error:', error));
    }
}

function saveWorkflow(id) {
    const row = document.querySelector(`#workflows-table tr[data-id="${id}"]`);
    const name = row.querySelector('[data-field="name"]').innerText;
    const content = row.querySelector('[data-field="content"]').innerText;

    fetch(`/workflows/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, content: content })
    })
    .then(response => response.json())
    .then(data => alert(`Workflow ${id} updated`))
    .catch(error => console.error('Error:', error));
}

function deleteWorkflow(id) {
    if (confirm(`Are you sure you want to delete workflow with ID ${id}?`)) {
        fetch(`/workflows/${id}`, {
            method: 'DELETE'
        })
        .then(() => {
            alert(`Workflow ${id} deleted`);
            // Refresh the list
            fetch('/workflows/')
                .then(response => response.json())
                .then(data => displayWorkflows(data))
                .catch(error => console.error('Error refreshing workflows:', error));
        })
        .catch(error => console.error('Error refreshing workflows:', error));
    }
}

document.getElementById('create-user-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const email = document.getElementById('user-email').value;

    fetch('/users/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        alert(`User created with ID: ${data.id}`);
        // Refresh user list after creating a new user
        fetch('/users/')
            .then(response => response.json())
            .then(data => displayUsers(data))
            .catch(error => console.error('Error refreshing users:', error));
    })
    .catch(error => console.error('Error:', error));
});

document.getElementById('create-node-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const ownerId = document.getElementById('node-owner').value;
    const name = document.getElementById('node-name').value;
    const content = document.getElementById('node-content').value;

    // Create a node with the owner_id in both query params and body
    fetch(`/nodes/?owner_id=${ownerId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: name,
            content: content,
            owner_id: parseInt(ownerId, 10) // Include in body too
        })
    })
    .then(response => response.json())
    .then(data => alert(`Node created with ID: ${data.id}`))
    .catch(error => console.error('Error:', error));
});

document.getElementById('create-workflow-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const ownerId = document.getElementById('workflow-owner').value;
    const name = document.getElementById('workflow-name').value;
    const content = document.getElementById('workflow-content').value;

    // Create a workflow with the owner_id in both query params and body
    fetch(`/workflows/?owner_id=${ownerId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: name,
            content: content,
            owner_id: parseInt(ownerId, 10) // Include in body too
        })
    })
    .then(response => response.json())
    .then(data => alert(`Workflow created with ID: ${data.id}`))
    .catch(error => console.error('Error:', error));
});
</script>

</body>
</html>
